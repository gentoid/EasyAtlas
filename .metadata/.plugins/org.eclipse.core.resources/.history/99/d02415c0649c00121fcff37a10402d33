package ru.osm.dkiselev.atlasgenerator;

import java.awt.geom.Area;
import java.io.ByteArrayInputStream;
import java.io.File;
import java.util.ArrayList;
import java.util.List;

import javax.xml.xpath.XPath;
import javax.xml.xpath.XPathConstants;

import org.odftoolkit.odfdom.dom.OdfContentDom;
import org.odftoolkit.odfdom.dom.attribute.text.TextAnchorTypeAttribute;
import org.odftoolkit.odfdom.dom.element.text.TextPElement;
import org.odftoolkit.odfdom.incubator.doc.draw.OdfDrawFrame;
import org.odftoolkit.odfdom.incubator.doc.draw.OdfDrawImage;
import org.odftoolkit.simple.TextDocument;
import org.w3c.dom.Node;

public class ODFGenerator {
	public static void main(String[] args) {
		
		String scale = args[1];
		String folder = args[0];
		
		TemplateParser template = new TemplateParser(Integer.valueOf(scale), new File(folder + "/map-page.ott"));
		
		File pagesDir = new File(folder + "/pages");
		if(!pagesDir.exists()) {
			pagesDir.mkdir();
		}
		
		try {
			
			template.parse();
			
			PolygonFileReader polygonFileReader = new PolygonFileReader(new File(args[2]));
			Area covereage = polygonFileReader.loadPolygon();
			GridGenerator gridGenerator = new GridGenerator(covereage);
			gridGenerator.generate(template.getScaledMapWidthM(), template.getScaledMapHeightM());
			
			MapRasterDataSource rds = new MapRasterDataSource(300, 
					"http://localhost/cgi-bin/qgis_mapserv.fcgi?map=/home/dkiselev/osm/walking-papers/bw.qgs",
					template.getWidthPX(), template.getHeightPX());
			
			for(GridCell c : gridGenerator.listCells() ) {
				byte[] content = rds.loadImage(c);
				
				TemplateParser newDocTemplate = insertImage(content, template, "map_page" + c.getPn() + ".png");
				insertPageRefs(newDocTemplate, c, template);
				
				String savePath = folder + "/pages/page" + c.getPn() + ".odt";
				newDocTemplate.getDocument().save(savePath);
			}
			
		} catch (Exception e) {
			e.printStackTrace();
		}
		
	}

	private static void insertPageRefs(TemplateParser newDocTemplate,
			GridCell c, TemplateParser template) throws Exception {

		TextDocument newTextDocument = template.getDocument();
		OdfContentDom contentDom = newTextDocument.getContentDom();
		XPath xpath = contentDom.getXPath();

		Node node = newDocTemplate.getFrameByName().get(TemplateParser.PAGE_NUMBER_FRAME);
		if(node != null) {
			TextPElement lastPara = (TextPElement) xpath.evaluate("//text:p[last()]", mapFrame, XPathConstants.NODE);
			if (lastPara == null) {
				throw new RuntimeException("Map frame doesn't contains paragraph.");
			}
		}
	}


	private static TemplateParser insertImage(byte[] content, TemplateParser template, String imgName) throws Exception {
		
		template = template.withNewDocument();
		TextDocument newTextDocument = template.getDocument();
		
		OdfContentDom contentDom = newTextDocument.getContentDom();
		OdfDrawFrame drawFrame = contentDom.newOdfElement(OdfDrawFrame.class);
		
		XPath xpath = contentDom.getXPath();		
		Node mapFrame = template.getFrameByName().get(TemplateParser.MAP_FRAME);
		TextPElement lastPara = (TextPElement) xpath.evaluate("//text:p[last()]", mapFrame, XPathConstants.NODE);
		if (lastPara == null) {
			throw new RuntimeException("Map frame doesn't contains paragraph.");
		}
		lastPara.appendChild(drawFrame);

		drawFrame.setSvgWidthAttribute((template.getWidthMM() / 10) + "cm");
		drawFrame.setSvgHeightAttribute((template.getHeightMM() / 10) + "cm");
		drawFrame.setTextAnchorTypeAttribute(TextAnchorTypeAttribute.Value.PARAGRAPH.toString());
		drawFrame.setStyleRelHeightAttribute("100%");
		drawFrame.setStyleRelWidthAttribute("100%");

		OdfDrawImage image = (OdfDrawImage) drawFrame.newDrawImageElement();
		image.newImage(new ByteArrayInputStream(content), "Pictures/" + imgName, "image/png");
		
		return template;
	}
}
